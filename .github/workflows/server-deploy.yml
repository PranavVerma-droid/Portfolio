name: Deploy to Production Server

on:
  push:
    branches: [ "master" ]

jobs:
  wait-for-builds:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Portfolio Docker Build
        uses: fountainhead/action-wait-for-check@v1.2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: build
          ref: ${{ github.event.push.head.sha || github.sha }}
          intervalSeconds: 10
          timeoutSeconds: 600
          
      - name: Wait for Blogs Docker Build  
        uses: fountainhead/action-wait-for-check@v1.2.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: build (Blogs Docker Build)
          ref: ${{ github.event.push.head.sha || github.sha }}
          intervalSeconds: 10
          timeoutSeconds: 600

  deploy:
    runs-on: self-hosted
    needs: wait-for-builds
    
    steps:
      - name: Deploy to Server
        run: |
          echo "Starting deployment..."
          cd /var/www/portfolio || exit 1
          echo "Resetting local changes..."
          git reset --hard HEAD
          git clean -fd
          echo "Pulling latest changes..."
          git fetch origin
          git reset --hard origin/master
          cd docker || exit 1
          echo "Pulling latest Docker images..."
          docker compose pull || exit 1
          echo "Starting containers..."
          docker compose up -d || exit 1
          echo "Deployment completed successfully"
        shell: bash