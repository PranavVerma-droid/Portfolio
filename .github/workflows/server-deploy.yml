name: Deploy to Production Server

on:
  workflow_run:
    workflows: ["Portfolio Docker Build", "Blogs Docker Build"]
    types:
      - completed
    branches:
      - master

jobs:
  deploy:
    runs-on: self-hosted
    if: |
      github.event.workflow_run.conclusion == 'success' && 
      !contains(github.event.workflow_run.head_commit.message, '[skip deploy]')
    
    steps:
      - name: Wait for Other Workflow
        run: |
          # Get the status of both workflows
          portfolio_status=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/docker-build.yml/runs?branch=master&per_page=1" | \
            jq -r '.workflow_runs[0].conclusion')
          
          blogs_status=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/docker-build-2.yml/runs?branch=master&per_page=1" | \
            jq -r '.workflow_runs[0].conclusion')
          
          # Only proceed if both workflows succeeded
          if [ "$portfolio_status" = "success" ] && [ "$blogs_status" = "success" ]; then
            echo "Both workflows completed successfully. Proceeding with deployment..."
          else
            echo "Not all workflows have completed successfully. Exiting."
            exit 1
          fi

      - name: Deploy to Server
        if: success()
        run: |
          echo "Starting deployment..."
          cd /var/www/portfolio || exit 1
          echo "Pulling latest changes..."
          git pull || exit 1
          cd docker || exit 1
          echo "Pulling latest Docker images..."
          docker compose pull || exit 1
          echo "Starting containers..."
          docker compose up -d || exit 1
          echo "Deployment completed successfully"
        shell: bash